<form hideEdit="true" theme="dark">
  <init>
    <unset token="and_nl"></unset>
    <unset token="and_tk"></unset>
    <set token="help_tk">on</set>
  </init>
  <label>Event Wizard</label>
  <search id="warnings">
    <query>| `check_rest_api` 
		   | fields msg, reset 
    </query>
  </search>
  <fieldset submitButton="false" autoRun="true">
    <input type="radio" token="help" searchWhenChanged="true">
      <label>HELP</label>
      <choice value="on">on</choice>
      <choice value="off">off</choice>
      <default>on</default>
      <initialValue>on</initialValue>
      <change>
        <condition value="off">
          <unset token="help_tk"></unset>
        </condition>
        <condition value="on">
          <set token="help_tk">on</set>
        </condition>
      </change>
    </input>
    <input type="multiselect" token="adverb" searchWhenChanged="true" depends="$and_nl$,$event$">
      <label>Modifier</label>
      <fieldForLabel>adverb_clean</fieldForLabel>
      <fieldForValue>adverb</fieldForValue>
      <search>
        <query>| `meta_query("adverb($event$)")` 
               | rename result AS adverb
               | eval adverb_clean=replace(adverb,"\_"," ")
        </query>
      </search>
      <choice value="any">Any</choice>
      <default>any</default>
      <initialValue>any</initialValue>
      <delimiter>,</delimiter>
    </input>
    <input type="dropdown" token="event" searchWhenChanged="true" rejects="$and_nl$">
      <label>Event</label>
      <fieldForLabel>event_clean</fieldForLabel>
      <fieldForValue>event</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv
               | dedup event 
               | sort event
               | eval event_clean=replace(event,"\_"," ")</query>
      </search>
    </input>
    <input type="link" token="event" searchWhenChanged="false" depends="$event$,$and_nl$">
      <label>Event</label>
      <fieldForLabel>event_clean</fieldForLabel>
      <fieldForValue>event</fieldForValue>
      <search>
        <query>| makeresults 
               | eval event="$event$"
               | eval event_clean=replace(event,"\_"," ")</query>
      </search>
    </input>
    <input type="dropdown" token="and" depends="$event$" searchWhenChanged="true">
      <showClearButton>false</showClearButton>
      <label>Query Type Selector</label>
      <choice value="select">SELECT AN OPTION</choice>
      <choice value="-">-</choice>
      <choice value="and">and</choice>
      <choice value="andnot">and is not true that</choice>
      <choice value="before">before</choice>
      <choice value="last">and the latest event</choice>
      <choice value="stats">stats</choice>
      <default>select</default>
      <initialValue>select</initialValue>
      <change>
        <condition value="select">
          <unset token="and_tk"></unset>
          <unset token="last_tk"></unset>
          <unset token="stats_tk"></unset>
          <unset token="before_tk"></unset>
          <unset token="and_nl"></unset>
        </condition>
        <condition value="-">
          <unset token="and_tk"></unset>
          <unset token="last_tk"></unset>
          <unset token="stats_tk"></unset>
          <unset token="before_tk"></unset>
          <set token="and_nl">-</set>
        </condition>
        <condition value="stats">
          <unset token="and_tk"></unset>
          <unset token="last_tk"></unset>
          <set token="stats_tk">stats</set>
          <unset token="before_tk"></unset>
          <set token="and_nl">none</set>
        </condition>
        <condition value="and">
          <set token="and_tk">and</set>
          <unset token="last_tk"></unset>
          <unset token="stats_tk"></unset>
          <set token="before_tk">and</set>
          <set token="and_nl">and</set>
        </condition>
        <condition value="andnot">
          <set token="and_tk">and not</set>
          <unset token="last_tk"></unset>
          <unset token="stats_tk"></unset>
          <set token="before_tk">and</set>
          <set token="and_nl">and is not true that</set>
        </condition>
        <condition value="before">
          <set token="and_tk">and</set>
          <unset token="last_tk"></unset>
          <unset token="stats_tk"></unset>
          <set token="before_tk">before</set>
          <set token="and_nl">before</set>
        </condition>
        <condition value="last">
          <set token="and_tk">and latest</set>
          <set token="last_tk">last</set>
          <unset token="stats_tk"></unset>
          <set token="before_tk">and</set>
          <set token="and_nl">and the latest event about</set>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="stats_op" depends="$event$,$stats_tk$" searchWhenChanged="true">
      <showClearButton>false</showClearButton>
      <label>Operator</label>
      <choice value="avg">avg</choice>
      <choice value="count">count</choice>
      <choice value="distinct_count">distinct count</choice>
      <choice value="estdc">estdc</choice>
      <choice value="estdc_error">estdc error</choice>
      <choice value="max">max</choice>
      <choice value="median">median</choice>
      <choice value="min">min</choice>
      <choice value="mode">mode</choice>
      <choice value="range">range</choice>
      <choice value="standard_deviation">standard deviation</choice>
      <choice value="sum">sum</choice>
      <choice value="var">var</choice>
      <default>count</default>
      <initialValue>count</initialValue>
    </input>
    <input type="multiselect" token="by" searchWhenChanged="true" depends="$event$,$stats_tk$,$stats_op$">
      <label>By</label>
      <fieldForLabel>entity_clean</fieldForLabel>
      <fieldForValue>entity</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where event="$event$" AND entity!="eventRoot"
               | eval entity_clean=replace(entity,"\_"," ")
        </query>
      </search>
      <delimiter>,</delimiter>
    </input>
    <input type="dropdown" token="entity1" searchWhenChanged="true" depends="$event$,$and_tk$" rejects="$event1$">
      <label>Joining Entity</label>
      <fieldForLabel>entity_clean</fieldForLabel>
      <fieldForValue>entity</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where event="$event$" AND entity!="eventRoot"
               | eval entity_clean=replace(entity,"\_"," ")
        </query>
      </search>
    </input>
    <input type="link" token="entity1" searchWhenChanged="false" depends="$event$,$entity1$,$and_tk$,$event1$">
      <label>Joining Entity</label>
      <fieldForLabel>entity1</fieldForLabel>
      <fieldForValue>entity1</fieldForValue>
      <search>
        <query>| makeresults | eval entity1="$entity1$"</query>
      </search>
    </input>
    <input type="link" token="that1" depends="$event$,$entity1$,$and_tk$" searchWhenChanged="false">
      <label></label>
      <choice value="had">had</choice>
      <default>had</default>
      <initialValue>had</initialValue>
    </input>
    <input type="multiselect" token="adverb1" searchWhenChanged="true" depends="$event$,$event1$,$and_tk$">
      <label>Second Modifier</label>
      <fieldForLabel>adverb_clean</fieldForLabel>
      <fieldForValue>adverb</fieldForValue>
      <search>
        <query>| `meta_query("adverb($event1$)")` 
               | rename result AS adverb
               | eval adverb_clean=replace(adverb,"\_"," ")
        </query>
      </search>
      <choice value="any">Any</choice>
      <default>any</default>
      <initialValue>any</initialValue>
      <delimiter> ,</delimiter>
    </input>
    <input type="dropdown" token="event1" searchWhenChanged="true" depends="$event$,$entity1$,$and_tk$">
      <label>Second Event</label>
      <fieldForLabel>event_clean</fieldForLabel>
      <fieldForValue>event</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where entity="$entity1$"
               | dedup event | sort event | fields - entity
               | eval event_clean=replace(event,"\_"," ")
        </query>
      </search>
    </input>
    <input type="time" token="time" depends="$event$" searchWhenChanged="true">
      <label></label>
    </input>
  </fieldset>
  <row>
    <panel>
      <table>
        <search base="warnings">
          <query>fields - _time</query>
        </search>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition field="reset">
            <link target="_self">wizard_event</link>
          </condition>
          <condition field="msg">
            <link target="_blank">/manager/search/data/macros?ns=openintelligence_nli_app&amp;pwnr=-&amp;app_only=1&amp;search=oi_&amp;count=25</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <p>
        </p>
    </html>
    </panel>
  </row>
  <row>
    <panel depends="$and_nl$,$event$" rejects="$and_tk$,$stats_tk$">
      <table>
        <search>
          <query>| `query_one_event("any","eventRoot","$adverb$","$event$")`
|fields NLquery,splquery, status</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=$row.splquery$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel depends="$event$,$stats_tk$,$stats_op$,$by$" rejects="$and_tk$">
      <table>
        <search>
          <query>| `query_one_event_stats("any","event","$adverb$","$event$","$stats_op$","$by$")` 
|fields NLquery,splquery, status</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=$row.splquery$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$event$,$and_tk$,$entity1$,$event1$" rejects="$last_tk$">
    <panel>
      <title></title>
      <table>
        <search>
          <query>| `query_no_repeat("any","event","$adverb$","$event$","$and_nl$","any","$entity1$","$adverb1$","$event1$","$before_tk$")`
| fields NLquery, splquery, status</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=$row.splquery$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$event$,$and_tk$,$entity1$,$event1$,$last_tk$">
    <panel>
      <title></title>
      <table>
        <search>
          <query>| `query_no_repeat("any","event","$adverb$","$event$","$and_nl$","any","$entity1$","$adverb1$","$event1$","$before_tk$")`
| fields NLquery, splquery, status</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=$row.splquery$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$help_tk$" rejects="$event$">
    <panel>
      <html>
        <p>
          <strong>Select the first event in your search</strong>
          <br/>
           Select the first event in your search (e.g. <i>authentication</i> in the search: <i>failed authentication</i>).
        </p>
    </html>
    </panel>
  </row>
  <row depends="$event$,$help_tk$" rejects="$and_nl$">
    <panel>
      <html>
        <p>
          <strong>Select a Query Type</strong>
          <br/>
          <strong>*</strong> To generate a query, select the "-" option 
          <br/>
          <strong>*</strong> You could also select a Logical Operator (e.g. and) to create a stats/correlation query.
        </p>
    </html>
    </panel>
  </row>
  <row depends="$event$,$and_nl$,$help_tk$" rejects="$and_tk$,$stats_tk$">
    <panel>
      <html>
        <p>
          <strong>Execute the generated query and/or select relevant event modifiers</strong>
          <br/>
          <strong>*</strong>Select an optional time period and click on the splquery row above. 
          <br/>
          <strong>*</strong>You could also select any number of optional adverbs/modifiers (e.g. <i>failed</i> for authentication) to further constrain the events and wait for the resulting query. 
        </p>
    </html>
    </panel>
  </row>
  <row depends="$stats_tk$,$help_tk$" rejects="$by$">
    <panel>
      <html>
        <p>
          <strong>Group the data by selecting one or more BY entities</strong>
          <br/>
    <strong>*</strong> Group the data by selecting one or more applicable entities in BY. 
          <br/>
          <strong>*</strong>You could also change the statistical operator from the default "count".
        </p>
    </html>
    </panel>
  </row>
  <row depends="$stats_tk$,$help_tk$,$by$">
    <panel>
      <html>
        <p>
          <strong>Execute the generated statiscal query and/or select relevant event modifiers</strong>
          <br/>
          <strong>*</strong> To execute the query, select an optional time period and click on the splquery row above
          <br/>
          <strong>*</strong> You could select any number of optional adverbs/modifiers (e.g. <i>failed</i> for authentication) to further constrain the events and wait for the resulting query. 
        </p>
    </html>
    </panel>
  </row>
  <row depends="$and_tk$,$help_tk$" rejects="$entity1$">
    <panel>
      <html>
        <p>
          <strong>Select a joining Entity.</strong>
          <br/>
    Select the entity that will be used for correlating with the second event.
        </p>
    </html>
    </panel>
  </row>
  <row depends="$and_tk$,$entity1$,$help_tk$" rejects="$event1$">
    <panel>
      <html>
        <p>
          <strong>Select a second event</strong>
          <br/>
           Select the second event to be correlated
        </p>
    </html>
    </panel>
  </row>
  <row depends="$and_tk$,$entity1$,$event1$,$help_tk$">
    <panel>
      <html>
        <p>
          <strong>Execute the query and select optional modifiers</strong>
          <br/>
          <strong>*</strong> To execute the query, select an optional time period and click on the splquery row above
          <br/>
          <strong>*</strong> You could select any number of modifiers for qualifying the second event (if needed)
          <br/>
          <strong>*</strong> You could also change anytime the Logical Operation joining the both events or change the second event but remember to reset first the modifiers in that case
        </p>
    </html>
    </panel>
  </row>
</form>