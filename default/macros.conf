[check_rest_api]
definition = makeresults | appendcols [ | `meta_query("version()")` | head 1 | fields result ] | eval user=`oi_user`, host=`oi_host`, port=`oi_port`, msg="Using user \"".user."\" for Rest API server \"".host.":".port."\" version ".result, msg=if(result=="","Rest API server \"".host."\" not responding/missing.",msg), msg=if(user=="","Rest API user missing. Remember to update passwords.conf as well.",msg), msg=if(host=="","Rest API host missing. Remember to check if oi_port is correct as well.",msg)
iseval = 0

[compile_query(5)]
args = query,and,query1,stats_op,by
definition = `format_query("$query$","$and$","$query1$","$stats_op$","$by$")` | map search="| makeresults | `rest_query(\"$intent$\",\"nat1\")`"
iseval = 0

[format_query(5)]
args = query,and,query1,stats_op,by
definition = makeresults | eval and=case(isnull("$and$"),"","$and$"=="-","",1=1,"$and$"), stats_op=case(isnull("$stats_op$"),"","$stats_op$"=="-","",1=1,"$stats_op$"), \
by=case(isnull("$by$"),"","$by$"=="-","",1=1,"$by$"), \
intent=if(and=="","$query$","$query$ ".and." $query1$"), intent=case(stats_op=="",intent,by==""," ".stats_op." ".intent,1=1," ".stats_op." ".intent." by $by$")
iseval = 0

[meta_query(1)]
args = query
definition = makeresults | `rest_query("$query$","meta_query_response")`
iseval = 0

[meta_query(4)]
args = uri, user, pass, query
definition = eval header="{\"content-type\":\"application/json\"}", data="{\"query\":\"$query$\"}" | curl method=get uri="$uri$" user="$user$" pass="$pass$"  debug=true headerfield=header datafield=data
iseval = 0
disabled = 0

[oi_host]
iseval = 0
definition = "localhost"

[oi_port]
definition = "10000"
iseval = 0

[oi_user]
definition = ""
iseval = 0

[oi_pass]
definition = ""
iseval = 0

[process_old_search]
definition = index=_audit app="openintelligence_nli_app", provenance="UI:Dashboard:*", mode="historical" "eval m111=111" info=completed NOT "8765=6789" NOT "$row"  | eval search=ltrim(search,"'"), search=rtrim(search,"'"),search1=split(search,"| eval m111=111,"), splquery=mvindex(search1,0), search2=mvindex(search1,1), search2=replace(search2,"\"",""), search2=replace(search2,"'",""),search2=split(search2,","),\
intent=mvindex(search2,0),intent=replace(intent,"intent=",""),\
adjective=mvindex(search2,1),adjective=replace(adjective,"adjective=",""),\
entity=mvindex(search2,2),entity=replace(entity,"entity=",""),\
adverb=mvindex(search2,3),adverb=replace(adverb,"adverb=",""),\
event=mvindex(search2,4),event=replace(event,"event=",""),\
stats_op=mvindex(search2,5),stats_op=replace(stats_op,"stats_op=",""),\
by=mvindex(search2,6), by=replace(by,"by=",""),entity=if(entity=="","eventRoot",entity),visualisePage=if(stats_op=="-","visualise_search","visualise_stats"),normalsplquery=replace(splquery,"\"","___")
iseval = 0

[process_query(1)]
args = intent
definition = makeresults | `rest_query("$intent$","nat1")`  | `process_result`
iseval = 0

[process_query(5)]
args = query,and,query1,stats_op,by
definition = `compile_query("$query$","$and$","$query1$","$stats_op$","$by$")` | `process_result`
iseval = 0

[process_result]
definition = eval status=case(curl_status=="408","No connection could be made because the target machine actively refused it",isnull(splquery),"Could not understand: ".data,type=="error","Could not understand: ".data,others!="",others,isnull(status),"OK",status=="","OK",1=1,status),stats_op=case(isnull(stats_op),"-",stats_op=="","-",1=1,stats_op), \
#by=case(isnull(by),"eventRoot",by=="","eventRoot",1=1,by), caveats=if(match(splquery,"\sdatamodel[\s\=]"),"Results would be faster if Model ".event." is accelerated",""),len=len(splquery),"Refine Query"=if(len>0,"CLICK HERE",""), "Visualise Query"=if(len>0,"CLICK HERE",""),entity=if(entity=="","eventRoot",entity),event=if(event=="","-",event),visualisePage=if(stats_op=="-","visualise_search","visualise_stats"),,normalsplquery=replace(splquery,"\"","___")
definition = eval status=case(curl_status=="408","No connection could be made because the target machine actively refused it",isnull(splquery),"Could not understand: ".data,type=="error","Could not understand: ".data,others!="",others,isnull(status),"OK",status=="","OK",1=1,status),stats_op=case(isnull(stats_op),"-",stats_op=="","-",1=1,stats_op), \
by=case(isnull(by),"eventRoot",by=="","eventRoot",1=1,by), caveats=if(match(splquery,"\sdatamodel[\s\=]"),"Results would be faster if Model ".event." is accelerated",""),len=len(splquery),"Refine Query"=if(len>0,"CLICK HERE",""), "Visualise Query"=if(len>0,"CLICK HERE",""),entity=if(entity=="","eventRoot",entity),event=if(event=="","-",event),visualisePage=if(stats_op=="-","visualise_search","visualise_stats"),normalsplquery=replace(splquery,"\"","___")
iseval = 0

[rest_query(2)]
args = query,query_type
definition = eval user=`oi_user`,pass=`oi_pass`,host=`oi_host`,port=`oi_port`,uri="https://".host.":".port."/rest/$query_type$", meta_query="$query$" | eval result=splquery\
| map search="|  makeresults | `meta_query("$uri$","$user$","$pass$","$meta_query$")` | fields - _time " | spath input=curl_message path=result{} \
|  rename "result{}" as result\
|  mvexpand result\
|  spath input=result \
|  rename result.* AS *
iseval = 0

[sync_cached_event]
definition = `meta_query("eventFull()")` \
|  eval result=split(result,"#"),entity=mvindex(result,0), event=mvindex(result,1) \
| table entity, event

[sync_cached_entity]
definition = `meta_query("entityFull()")` | eval result=split(result,"#"),entity=mvindex(result,0), type=mvindex(result,1), mapping=mvindex(result,2) | fields entity, type, mapping


################################

#[rest_query(2)]
#definition = eval user=`oi_user`,host=`oi_host`,port=`oi_port`,uri="https://".host.":".port."/rest/$query_type$", meta_query="$query$"\
#| map search="|  makeresults | `curl_meta_query("$uri$","$user$","$meta_query$")` | fields - _time " | spath input=curl_message | rename "result{}" AS results | mvexpand "results" | eval results=split(results,"#"), result0=mvindex(results,0), result=if(isnull(result0),result,result0), status=if(type="delayed","OK",type) |  fields type, result, results, status
#iseval = 0

# 
# IndexForSourcetype (generated using =CONCATENATE("[";A37;"]";CHAR(10);"definition =";B37;CHAR(10);CHAR(10)))
#
[account_change_indexes]
definition =`cim_Account_Management_indexes`
iseval = 0

[alert_indexes]
definition =`cim_Alerts_indexes`

[application_state_indexes]
definition =`cim_Endpoint_indexes`


[applocker_indexes]
definition =index="windows"


[authentication_indexes]
definition =`cim_Authentication_indexes`


[backup_indexes]
definition =index=*


[certificate_generation_indexes]
definition =`cim_All_Certificates_indexes`


[change_indexes]
definition =`cim_All_Changes_indexes`


[data_exfiltration_attempt_indexes]
definition =`cim_DLP_Incidents_indexes`


[database_state_indexes]
definition =`cim_All_Databases_indexes`


[discovery_indexes]
definition =`cim_All_Inventory_indexes`


[email_indexes]
definition =`cim_All_Email_indexes`


[filesystem_state_indexes]
definition =`cim_Filesystem_indexes`


[intrusion_detection_indexes]
definition =`cim_IDS_Attacks_indexes`


[jvm_execution_indexes]
definition =`cim_JVM_indexes`


[malware_infection_indexes]
definition =`cim_Malware_Attacks_indexes`


[malware_remediation_attempt_indexes]
definition =`cim_Malware_Operations_indexes`


[message_reception_indexes]
definition =`cim_All_Messaging_indexes`


[multi_factor_authentication_indexes]
definition =`cim_Authentication_indexes`


[network_request_indexes]
definition =`cim_All_Traffic_indexes`


[network_resolution_indexes]
definition =`cim_DNS_indexes`


[network_session_indexes]
definition =`cim_All_Sessions_indexes`


[patch_indexes]
definition =`cim_Updates_indexes`


[performance_indexes]
definition =`cim_All_Performance_indexes`


[port_state_indexes]
definition =`cim_Ports_indexes`


[registry_state_indexes]
definition =index=*


[service_request_indexes]
definition =`cim_All_Ticket_Management_indexes`


[splunk_audit_modular_action_indexes]
definition =`cim_Modular_Actions_indexes`


[splunk_ui_access_indexes]
definition =index="_internal"


[web_request_indexes]
definition =`cim_Web_indexes`


[whitelist_indexes]
definition =index="windows"


[windows_event_indexes]
definition =index="windows"


[windows_update_indexes]
definition =index="windows"


[vulnerability_indexes]
definition =`cim_Vulnerabilities_indexes`


[nessus_plugin_indexes]
definition =index=*


[tenable_plugin_indexes]
definition =index=*


