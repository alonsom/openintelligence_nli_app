<form hideEdit="true" theme="dark">
  <init>
    <set token="repeatEntity_tk">alone</set>
    <unset token="and_tk"></unset>
    <unset token="splquery"></unset>
    <set token="help_tk">on</set>
    <set token="pivot_tk">timechart</set>
  </init>
  <label>Entity Wizard</label>
  <search id="base"><query>$splquery$</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <fieldset submitButton="false" autoRun="true">
    <html>
      <a target="_self" href="wizard_entity">Reset the form before start building a new query (click here to reset)</a>
      <br/>
    </html>
    <input type="dropdown" token="help" searchWhenChanged="true">
      <label></label>
      <choice value="on">Help</choice>
      <choice value="off">No Help</choice>
      <change>
        <condition value="off">
          <unset token="help_tk"></unset>
        </condition>
        <condition value="on">
          <set token="help_tk">on</set>
        </condition>
      </change>
      <default>Help</default>
      <initialValue>Help</initialValue>
    </input>
    <input type="dropdown" token="entity" searchWhenChanged="true" rejects="$entity$">
      <label>Entity</label>
      <fieldForLabel>entity_clean</fieldForLabel>
      <fieldForValue>entity</fieldForValue>
      <search>
        <query>| inputlookup cached_entity.csv
               | eval entity_clean=replace(entity,"\_"," ")</query>
      </search>
    </input>
    <input type="multiselect" token="adjective" searchWhenChanged="true" depends="$entity$">
      <label>$entity$ adjective/sub entity</label>
      <fieldForLabel>adjective_clean</fieldForLabel>
      <fieldForValue>adjective</fieldForValue>
      <search>
        <query>| `meta_query("adjective($entity$)")` 
               | rename result AS adjective 
               | eval adjective_clean=replace(adjective,"\_"," ")</query>
      </search>
      <choice value="any">Any</choice>
      <default>any</default>
      <delimiter>,</delimiter>
      <initialValue>any</initialValue>
    </input>
    <input type="multiselect" token="adverb" searchWhenChanged="true" depends="$event$">
      <label>$event$ modifier</label>
      <fieldForLabel>adverb_clean</fieldForLabel>
      <fieldForValue>adverb</fieldForValue>
      <search>
        <query>| `meta_query("adverb($event$)")` 
               | rename result AS adverb
               | eval adverb_clean=replace(adverb,"\_"," ")
        </query>
      </search>
      <choice value="any">Any</choice>
      <default>any</default>
      <initialValue>any</initialValue>
      <delimiter>,</delimiter>
    </input>
    <input type="dropdown" token="event" searchWhenChanged="true" depends="$entity$" rejects="$event$">
      <label>Event</label>
      <fieldForLabel>event_clean</fieldForLabel>
      <fieldForValue>event</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where entity="$entity$" AND entity!="eventRoot" 
               | eval event_clean=replace(event,"\_"," ")
        </query>
      </search>
    </input>
    <input type="dropdown" token="query_mod" searchWhenChanged="true" depends="$entity$">
      <label>Query Modifiers</label>
      <choice value="-">-</choice>
      <choice value="stats">stats</choice>
      <default>-</default>
      <initialValue>-</initialValue>
      <change>
        <condition value="-">
          <unset token="stats_tk"></unset>
        </condition>
        <condition value="stats">
          <set token="stats_tk">stats</set>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="and" depends="$entity$,$event$" searchWhenChanged="true">
      <showClearButton>false</showClearButton>
      <label>Query Type Selector</label>
      <choice value="-">-</choice>
      <choice value="and">and</choice>
      <choice value="andnot">and is not true that</choice>
      <choice value="before">before</choice>
      <choice value="last">and the latest event</choice>
      <choice value="around">and around the same time</choice>
      <default>-</default>
      <initialValue>-</initialValue>
      <change>
        <condition value="-">
          <unset token="and_tk"></unset>
          <unset token="splquery"></unset>
        </condition>
        <condition value="stats">
          <unset token="and_tk"></unset>
          <unset token="splquery"></unset>
        </condition>
        <condition value="and">
          <set token="and_tk">and</set>
          <unset token="splquery"></unset>
        </condition>
        <condition value="andnot">
          <set token="and_tk">and is not true that</set>
          <unset token="splquery"></unset>
        </condition>
        <condition value="before">
          <set token="and_tk">before</set>
          <unset token="splquery"></unset>
        </condition>
        <condition value="last">
          <set token="and_tk">and the latest event about</set>
          <unset token="splquery"></unset>
        </condition>
        <condition value="around">
          <set token="and_tk">and around the same time</set>
          <unset token="splquery"></unset>
        </condition>
      </change>
    </input>
    <input type="multiselect" token="adjective1" searchWhenChanged="true" depends="$event$,$entity1$,$event1$">
      <label>$entity1$ adjective/sub entity</label>
      <fieldForLabel>adjective_clean</fieldForLabel>
      <fieldForValue>adjective</fieldForValue>
      <search>
        <query>| `meta_query("adjective($entity1$)")` 
               | rename result AS adjective 
               | eval adjective_clean=replace(adjective,"\_"," ")
        </query>
      </search>
      <delimiter>,</delimiter>
      <choice value="any">this</choice>
      <default>any</default>
      <initialValue>any</initialValue>
    </input>
    <input type="dropdown" token="entity1" searchWhenChanged="true" depends="$event$,$and_tk$" rejects="$event1$,$entity1$">
      <label>Second Entity (joining)</label>
      <fieldForLabel>entity_clean</fieldForLabel>
      <fieldForValue>entity</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where event="$event$" AND entity!="eventRoot" 
               | eval entity_clean=replace(entity,"\_"," ")</query>
      </search>
    </input>
    <input type="radio" token="repeatEntity" depends="$event$,$and_tk$,$entity1$" searchWhenChanged="true" rejects="$event1$">
      <label></label>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>value</fieldForValue>
      <search>
        <query>| makeresults | eval name="together with this $entity$", value="$entity$" | where value!="$entity1$"</query>
      </search>
      <choice value="alone">alone</choice>
      <default>alone</default>
      <initialValue>alone</initialValue>
      <change>
        <condition value="alone">
          <set token="repeatEntity_tk">alone</set>
        </condition>
        <condition>
          <unset token="repeatEntity_tk"></unset>
        </condition>
      </change>
    </input>
    <input type="multiselect" token="adverb1" searchWhenChanged="true" depends="$event$,$event1$,$and_tk$">
      <label>$event1$ modifier</label>
      <fieldForLabel>adverb_clean</fieldForLabel>
      <fieldForValue>adverb</fieldForValue>
      <search>
        <query>| `meta_query("adverb($event1$)")` 
               | rename result AS adverb
               | eval adverb_clean=replace(adverb,"\_"," ")
        </query>
      </search>
      <choice value="any">Any</choice>
      <default>any</default>
      <initialValue>any</initialValue>
      <delimiter> ,</delimiter>
    </input>
    <input type="dropdown" token="event1" searchWhenChanged="true" depends="$entity$,$event$,$and_tk$,$entity1$" rejects="$event1$,$repeatEntity$">
      <label>Second Event</label>
      <fieldForLabel>event_clean</fieldForLabel>
      <fieldForValue>event</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where entity="$entity$" 
               | dedup event | sort event | fields - entity 
               | join max=0 event [ |inputlookup cached_event.csv where entity="$entity1$"  | fields - entity ]
               | eval event_clean=replace(event,"\_"," ")
        </query>
      </search>
    </input>
    <input type="dropdown" token="event1" searchWhenChanged="true" rejects="$event1$" depends="$entity$,$event$,$entity1$,$and_tk$,$repeatEntity$">
      <label>Second Event</label>
      <fieldForLabel>event_clean</fieldForLabel>
      <fieldForValue>event</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where entity="$entity1$"
               | dedup event | sort event | fields - entity
               | eval event_clean=replace(event,"\_"," ")
       </query>
      </search>
    </input>
    <input type="dropdown" token="query_mod" searchWhenChanged="true" depends="$entity1$">
      <label>Query Modifiers</label>
      <choice value="-">-</choice>
      <choice value="stats">stats</choice>
      <default>-</default>
      <initialValue>-</initialValue>
      <change>
        <condition value="-">
          <unset token="stats_tk"></unset>
        </condition>
        <condition value="stats">
          <set token="stats_tk">stats</set>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="stats_op" depends="$entity$,$event$,$stats_tk$" searchWhenChanged="true">
      <showClearButton>false</showClearButton>
      <label>Operator</label>
      <choice value="avg">avg</choice>
      <choice value="count">count</choice>
      <choice value="distinct_count">distinct count</choice>
      <choice value="estdc">estdc</choice>
      <choice value="estdc_error">estdc error</choice>
      <choice value="max">max</choice>
      <choice value="median">median</choice>
      <choice value="min">min</choice>
      <choice value="mode">mode</choice>
      <choice value="range">range</choice>
      <choice value="stdev">standard deviation</choice>
      <choice value="sum">sum</choice>
      <choice value="var">var</choice>
      <default>count</default>
      <initialValue>count</initialValue>
    </input>
    <input type="multiselect" token="by" searchWhenChanged="true" depends="$entity$,$event$,$stats_tk$,$stats_op$">
      <label>By</label>
      <fieldForLabel>entity_clean</fieldForLabel>
      <fieldForValue>entity</fieldForValue>
      <search>
        <query>| inputlookup cached_event.csv where event="$event$" AND entity!="eventRoot"
               | eval entity_clean=replace(entity,"\_"," ")
        </query>
      </search>
      <delimiter>,</delimiter>
    </input>
    <html>
      <br/>
    </html>
    <input id="text42" type="radio" token="splquery" searchWhenChanged="false" depends="$entity$" rejects="$event$,$stats_tk$">
      <label>Query</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>splquery</fieldForValue>
      <search>
        <query>| `query_one_entity("$adjective$","$entity$")` | eval splquery=if(status=="OK",splquery,"Error: ".status)</query>
      </search>
    </input>
    <input type="radio" token="splquery" searchWhenChanged="true" depends="$entity$,$event$" rejects="$and_tk$,$stats_tk$">
      <label>Query</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>splquery</fieldForValue>
      <search>
        <!-- query>| `query_one_event("$adjective$","$entity$","$adverb$","$event$")`  | eval splquery=replace(splquery,"\"","#"), splquery=if(status=="OK",splquery,"Error: ".status)</query -->
        <query>| `query_one_event("$adjective$","$entity$","$adverb$","$event$")`  | eval splquery=if(status=="OK",splquery,"Error: ".status)</query>
      </search>
    </input>
    <input type="radio" token="splquery" searchWhenChanged="true" depends="$entity$,$event$,$stats_tk$,$by$" rejects="$and_tk$">
      <label>Query.stats</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>splquery</fieldForValue>
      <search>
        <query>|  `query_one_event_stats("$adjective$","$entity$","$adverb$","$event$","$stats_op$","$by$")` 
 | eval splquery=if(status=="OK",splquery,"Error: ".status)</query>
      </search>
    </input>
    <input type="radio" token="splquery1" searchWhenChanged="true" depends="$entity$,$event$,$and_tk$" rejects="$entity1$,$stats_tk$">
      <label>Query</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>NLquery</fieldForValue>
      <search>
        <query>|  `format_query_one_event("$adjective$","$entity$","$adverb$","$event$")` | eval NLquery=NLquery." $and_tk$ ..."</query>
      </search>
    </input>
    <input type="radio" token="splquery1" searchWhenChanged="true" depends="$entity$,$event$,$and_tk$,$entity1$" rejects="$event1$,$stats_tk$,$stats_tk$">
      <label>Query1</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>NLquery</fieldForValue>
      <search>
        <query>|  `format_query_one_event("$adjective$","$entity$","$adverb$","$event$")` | eval adjective1=replace("$adjective1$","any,",""),adjective1=replace(adjective1,"any",""),NLquery=NLquery." $and_tk$ the ".adjective1." $entity1$ ..."</query>
      </search>
    </input>
    <input type="radio" token="splquery" searchWhenChanged="true" depends="$entity$,$event$,$and_tk$,$entity1$,$event1$" rejects="$repeatEntity_tk$,$stats_tk$">
      <label>Query.repeat</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>splquery</fieldForValue>
      <search>
        <query>|  `query_repeat("$adjective$","$entity$","$adverb$","$event$","$and_tk$","$adjective1$","$entity1$","$adverb1$","$event1$")`
 | eval splquery=if(status=="OK",splquery,"Error: ".status)</query>
      </search>
    </input>
    <input type="radio" token="splquery" searchWhenChanged="true" depends="$entity$,$event$,$and_tk$,$entity1$,$event1$,$stats_tk$,$by$" rejects="$repeatEntity_tk$">
      <label>Query.repeat.stats</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>splquery</fieldForValue>
      <search>
        <query>|  `query_repeat_stats("$adjective$","$entity$","$adverb$","$event$","$and_tk$","$adjective1$","$entity1$","$adverb1$","$event1$","$stats_op$","$by$")` 
 | eval splquery=if(status=="OK",splquery,"Error: ".status)</query>
      </search>
    </input>
    <input type="radio" token="splquery" searchWhenChanged="true" depends="$entity$,$event$,$and_tk$,$entity1$,$event1$,$repeatEntity_tk$" rejects="$stats_tk$">
      <label>Query.no.repeat</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>splquery</fieldForValue>
      <search>
        <query>| `query_no_repeat("$adjective$","$entity$","$adverb$","$event$","$and_tk$","$adjective1$","$entity1$","$adverb1$","$event1$")`
 | eval splquery=if(status=="OK",splquery,"Error: ".status)</query>
      </search>
    </input>
    <input type="radio" token="splquery" searchWhenChanged="true" depends="$entity$,$event$,$and_tk$,$entity1$,$event1$,$repeatEntity_tk$,$stats_tk$,$by$">
      <label>Query.no_repeat.stats</label>
      <fieldForLabel>NLquery</fieldForLabel>
      <fieldForValue>splquery</fieldForValue>
      <search>
        <query>|  `query_no_repeat_stats("$adjective$","$entity$","$adverb$","$event$","$and_tk$","$adjective1$","$entity1$","$adverb1$","$event1$","$stats_op$","$by$")` 
 | eval splquery=if(status=="OK",splquery,"Error: ".status)</query>
      </search>
    </input>
    <html>
      <br/>
    </html>
    <input type="dropdown" token="visualisation" depends="$event$,$splquery$" searchWhenChanged="true">
      <label>Visualisation</label>
      <choice value="timechart">Time Chart</choice>
      <choice value="pivot">Pivot</choice>
      <change>
        <condition value="timechart">
          <set token="timechart_tk">timechart</set>
          <unset token="pivot_tk"></unset>
        </condition>
        <condition value="pivot">
          <unset token="timechart_tk"></unset>
          <set token="pivot_tk">pivot</set>
        </condition>
      </change>
      <default>pivot</default>
      <initialValue>pivot</initialValue>
    </input>
    <input type="time" token="time" depends="$event$,$splquery$" searchWhenChanged="true">
      <label></label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <html>
      <br/>
    </html>
  </fieldset>
  <row depends="$splquery$">
    <panel>
      <title>Generated Query</title>
      <table>
        <title>$splquery$</title>
        <search>
          <query>| makeresults | eval preconditions="NONE" | fields - _time</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=$row.splquery$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$splquery$">
    <panel rejects="$stats_tk$">
      <title>Matching Events</title>
      <table>
        <search base="base">
          <query>| fields $entity$.name, host, source, sourcetype | fields - _raw</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
    <panel depends="$event$,$stats_tk$">
      <title>Matching Events</title>
      <table>
        <search base="base">
          <query></query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
    <panel depends="$event$,$timechart_tk$" rejects="$pivot_tk$,$stats_tk$">
      <title>Visualisation</title>
      <chart>
        <search base="base">
          <query>| timechart count by $entity$.name</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel depends="$event$,$pivot_tk$" rejects="$timechart_tk$,$stats_tk$">
      <title>Visualisation</title>
      <chart>
        <search>
          <query>$splquery$ | stats count by $entity$.name</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel depends="$event$,$timechart_tk$,$stats_tk$,$by$" rejects="$pivot_tk$">
      <title>Visualisation</title>
      <chart>
        <search base="base">
          <query>| timechart count by $stats_op$_$entity$.name</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel depends="$event$,$pivot_tk$,$stats_tk$,$by$" rejects="$timechart_tk$">
      <title>Visualisation</title>
      <chart>
        <search base="base">
          <query>| stats count by $stats_op$_$entity$.name</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$help_tk$" rejects="$entity$">
    <panel>
      <html>
        <p>
          <strong>Select an Entity.</strong>
          <br/>
    Start by selecting a relevant subject/object/component for your search (e.g. <i>account</i> is the main entity in the search: <i>privileged account with a failed authentication</i>). This entity will be part of the query result and might be used for joining events (if needed)
        </p>
    </html>
    </panel>
  </row>
  <row depends="$entity$,$help_tk$" rejects="$event$">
    <panel>
      <html>
        <p>
          <strong>Click on the generated query and/or select relevant adjectives</strong>
          <br/>
          <strong>*</strong>To execute the query generated by the current selection, click on the query checkbox and then update time period and/or visualisation
          <br/>
          <strong>*</strong> You could select any number of optional adjectives for qualifying the selected entity,  like <i>privileged</i> for privileged accounts, <i>all known</i> for well know entities or just leave <i>any</i> for matching any entity.
          <br/>
          <strong>*</strong> You could also select an event (e.g. <i>authentication</i> in the search: <i>privileged account with a failed authentication</i>).
        </p>
    </html>
    </panel>
  </row>
  <row depends="$event$,$help_tk$" rejects="$and_tk$">
    <panel>
      <html>
        <p>
          <strong>Click on the generated query and/or select relevant adjectives/adverbs</strong>
          <br/>
          <strong>*</strong> To execute the query generated by the current selection, click on the query checkbox and then update time period and/or visualisation
          <br/>
          <strong>*</strong> You could also select a Logical Operator (e.g. and) and/or Query Modifier to create complex queries including stats/correlations.
        </p>
    </html>
    </panel>
  </row>
  <row depends="$event$,$help_tk$" rejects="$and_tk$,$stats_tk$">
    <panel>
      <html>
        <p>
          <strong>Execute the generated query and/or select relevant event modifiers</strong>
          <br/>
          <strong>*</strong> To execute the query, select an optional time period and click on the splquery row above
          <br/>
          <strong>*</strong> You could select any number of optional adverbs/modifiers (e.g. <i>failed</i> for authentication) to further constraint the events and wait for the resulting query. 
          <br/>
          <strong>*</strong> You could also select a Logical Operator (e.g. and) to create a correlation query.
        </p>
    </html>
    </panel>
  </row>
  <row depends="$stats_tk$,$help_tk$" rejects="$by$">
    <panel>
      <html>
        <p>
          <strong>Group the data by selecting one or more BY entities</strong>
          <br/>
    <strong>*</strong> Group the data by selecting one or more applicable entities in BY. 
          <br/>
          <strong>*</strong>You could also change the statistical operator from the default "count".
        </p>
    </html>
    </panel>
  </row>
  <row depends="$stats_tk$,$help_tk$,$by$">
    <panel>
      <html>
        <p>
          <strong>Execute the generated statiscal query and/or select relevant event modifiers</strong>
          <br/>
          <strong>*</strong> To execute the query, select an optional time period and click on the splquery row above
          <br/>
          <strong>*</strong> You could select any number of optional adverbs/modifiers (e.g. <i>failed</i> for authentication) to further constraint the events and wait for the resulting query. 
        </p>
    </html>
    </panel>
  </row>
  <row depends="$and_tk$,$help_tk$" rejects="$entity1$">
    <panel>
      <html>
        <p>
          <strong>Select a second Entity.</strong>
          <br/>
    Select the entity that will appear in the second part of the query (e.g. <i>device</i>) or just reuse the first entity. This is the main correlation entity.
        </p>
    </html>
    </panel>
  </row>
  <row depends="$and_tk$,$entity1$" rejects="$event1$">
    <panel>
      <html>
        <p>
          <strong>Select all relevant adjectives for the second entity and the second event</strong>
          <br/>
          <strong>*</strong> Select any number of adjectives for qualifying the second entity (if needed)
          <br/>
          <strong>*</strong> You could decide to use both entities for correlating the first and second events (or just leave the second entity)
          <br/>
          <strong>*</strong> Select the second event
        </p>
    </html>
    </panel>
  </row>
  <row depends="$and_tk$,$entity1$,$event1$,$help_tk$">
    <panel>
      <html>
        <p>
          <strong>Select all modifiers applicable to the second event and wait for the resulting query</strong>
          <br/>
          <strong>*</strong> Select any number of modifiers for qualifying the second event (if needed)
          <br/>
          <strong>*</strong> To execute the query, select an optional time period and click on the splquery row above
          <br/>
          <strong>*</strong> You could also change anytime the Logical Operation joining the both events
        </p>
    </html>
    </panel>
  </row>
  <row depends="noshow">
    <panel>
      <html>
        <!--color:#1A237E !important;
          background-color:#F0F0F0 !important; -->
      <style>
        .splunk-radiogroup {
          min-width: 530px !important;
          width: 730px !important;
          max-width: 730px !important;
          background-color:#030521 !important;
        }
        .splunk-radiogroup .select2-container {
          min-width: 340px !important;
          width: 340px !important;
          max-width: 340px !important;
          background-color:#030521 !important;
        }
      </style>
    </html>
    </panel>
  </row>
</form>