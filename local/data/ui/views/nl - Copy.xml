<form hideEdit="true" theme="dark">
  <init>
    <unset token="query_tk"></unset>
    <unset token="query1_tk"></unset>
    <unset token="and_tk"></unset>
    <unset token="stats_tk"></unset>
    <set token="help_tk">on</set>
    <set token="pivot_tk">timechart</set>
  </init>
  <label>Natural Language Search</label>
  <search id="base">
    <query>$form.splquery$</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <fieldset submitButton="false" autoRun="true">
    <html>
      <a target="_self" href="wizard_entity">Reset the form before start building a new query (click here to reset)</a>
      <br/>
    </html>
    <input id="text" type="text" token="query" searchWhenChanged="true" rejects="$form.splquery$">
      <label>First Natural Language Query</label>
      <change>
        <condition value="">
          <unset token="query_tk"></unset>
        </condition>
        <condition>
          <set token="query_tk">on</set>
        </condition>
      </change>
    </input>
    <input type="radio" token="and" depends="$query_tk$" searchWhenChanged="true">
      <label></label>
      <choice value="-">-</choice>
      <choice value="and">and</choice>
      <choice value="andnot">and is not true that</choice>
      <choice value="before">before</choice>
      <choice value="last">and the latest event</choice>
      <choice value="around">and around the same time</choice>
      <default>-</default>
      <initialValue>-</initialValue>
      <change>
        <condition value="-">
          <unset token="and_tk"></unset>
        </condition>
        <condition value="and">
          <set token="and_tk">and</set>
        </condition>
        <condition value="andnot">
          <set token="and_tk">and is not true that</set>
        </condition>
        <condition value="before">
          <set token="and_tk">before</set>
        </condition>
        <condition value="last">
          <set token="and_tk">and the latest event about</set>
        </condition>
        <condition value="around">
          <set token="and_tk">and around the same time</set>
        </condition>
      </change>
    </input>
    <input id="text1" type="text" token="query1" depends="$query_tk$,$and_tk$" searchWhenChanged="true">
      <label>Second Natural Language Query</label>
      <change>
        <condition value="">
          <unset token="query1_tk"></unset>
        </condition>
        <condition>
          <set token="query1_tk">on</set>
        </condition>
      </change>
    </input>
    <html>
      <br/>
    </html>
    <input type="dropdown" token="help" searchWhenChanged="true" rejects="$form.splquery$">
      <label></label>
      <choice value="on">Help</choice>
      <choice value="off">No Help</choice>
      <change>
        <condition value="off">
          <unset token="help_tk"></unset>
        </condition>
        <condition value="on">
          <set token="help_tk">on</set>
        </condition>
      </change>
      <default>on</default>
      <initialValue>on</initialValue>
    </input>
    <input type="dropdown" token="query_mod" searchWhenChanged="true" depends="$query_tk$">
      <label>Query Modifiers</label>
      <choice value="-">-</choice>
      <choice value="stats">stats</choice>
      <default>-</default>
      <initialValue>-</initialValue>
      <change>
        <condition value="-">
          <unset token="stats_tk"></unset>
        </condition>
        <condition value="stats">
          <set token="stats_tk">stats</set>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="stats_op" depends="$stats_tk$" searchWhenChanged="true">
      <showClearButton>false</showClearButton>
      <label>Operator</label>
      <choice value="avg">avg</choice>
      <choice value="count">count</choice>
      <choice value="distinct_count">distinct count</choice>
      <choice value="estdc">estdc</choice>
      <choice value="estdc_error">estdc error</choice>
      <choice value="max">max</choice>
      <choice value="median">median</choice>
      <choice value="min">min</choice>
      <choice value="mode">mode</choice>
      <choice value="range">range</choice>
      <choice value="stdev">standard deviation</choice>
      <choice value="sum">sum</choice>
      <choice value="var">var</choice>
      <default>count</default>
      <initialValue>count</initialValue>
    </input>
    <input type="multiselect" token="by" searchWhenChanged="true" depends="$stats_tk$,$stats_op$">
      <label>By</label>
      <fieldForLabel>entity_clean</fieldForLabel>
      <fieldForValue>entity</fieldForValue>
      <search>
        <query>| makeresults | eval event="authentication" 
| lookup cached_event.csv event AS event  OUTPUT entity | mvexpand  entity | where entity!="eventRoot"
| eval entity_clean=replace(entity,"\_"," ")
        </query>
      </search>
      <delimiter>,</delimiter>
    </input>
    <input type="dropdown" token="visualisation" depends="$form.event$,$form.splquery$" searchWhenChanged="true">
      <label>Visualisation</label>
      <choice value="timechart">Time Chart</choice>
      <choice value="pivot">Pivot</choice>
      <change>
        <condition value="timechart">
          <set token="timechart_tk">timechart</set>
          <unset token="pivot_tk"></unset>
        </condition>
        <condition value="pivot">
          <unset token="timechart_tk"></unset>
          <set token="pivot_tk">pivot</set>
        </condition>
      </change>
      <default>pivot</default>
      <initialValue>pivot</initialValue>
    </input>
    <input type="time" token="time" depends="$form.event$,$form.splquery$" searchWhenChanged="true">
      <label></label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <html>
      <br/>
    </html>
  </fieldset>
  
  <row depends="$query$,$query_tk$" rejects="$splquery$,$and_tk$,$query1_tk$,$query1$,$stats_tk$">
    <panel>
      <title>Select Preferred Meaning</title>
      <table>
        <search>
          <query>| `process_query("$query$")`</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <fields>["Refine Query","Visualise Query"]</fields>
        <drilldown>
          <condition field="Visualise Query">
            <link>nl?form.full_query=$row.full_query$&amp;form.splquery=$row.splquery$</link>
          </condition>
          <condition field="Refine Query">
            <link>nl?form.event=$row.event$&amp;form.query_tk=on&amp;form.query=$row.query$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$query$,$query_tk$,$and_tk$,$query1$,$query1_tk$" rejects="$splquery$,$stats_tk$">
    <panel>
      <title>Select Preferred Meaning</title>
      <table>
        <search>
          <query>| `process_query("$query$"," "$and_tk$","$query1$")`</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <fields>["Refine Query","Visualise Query"]</fields>
        <drilldown>
          <condition field="Visualise Query">
            <link target="self">nl?form.full_query=$row.full_query$&amp;form.splquery=$row.splquery$</link>
          </condition>
          <condition field="Refine Query">
            <link target="self">nl?event=$row.event$&amp;query_tk=on&amp;query=$row.query$&amp;and_tk=$row.and_tk$&amp;query1_tk=on&amp;query1=$row.query1$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$query$,$query_tk$,$stats_tk$,$by$" rejects="$splquery$,$and_tk$,$query1_tk$">
    <panel>
      <title>Select Preferred Meaning</title>
      <table>
        <search>
          <query>| `process_query("$stats_op$ $query$ by $by$")`</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <fields>["Refine Query","Visualise Query"]</fields>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition field="Refine Query">
            <link target="self">nl?form.full_query=$row.full_query$&amp;form.splquery=$row.splquery$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$query$,$query_tk$,$stats_tk$,$by$,$and_tk$,$query1_tk$" rejects="$splquery$">
    <panel>
      <title>Select Preferred Meaning</title>
      <table>
        <title>$query$</title>
        <search>
          <query>| `process_query("$stats_op$ $query$ $and_tk$ $query1$ by $by$")`</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <fields>["Refine Query","Visualise Query"]</fields>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition field="Refine Query">
            <link target="self">nl?form.full_query=$row.full_query$&amp;form.splquery=$row.splquery$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$form.splquery$">
    <panel>
      <title>Generated Query for $form.full_query$</title>
      <table>
        <title>$form.splquery$</title>
        <search>
          <query>| makeresults | eval preconditions="NONE" | fields - _time</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=$row.splquery$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$form.splquery$">
    <panel rejects="$stats_tk$">
      <title>Matching Events</title>
      <table>
        <search base="base">
          <query>| fields *.name, host, source, sourcetype | fields - _raw</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
    <panel depends="$form.event$,$stats_tk$">
      <title>Matching Events</title>
      <table>
        <search base="base">
          <query/>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
    <panel depends="$form.event$,$timechart_tk$" rejects="$pivot_tk$,$stats_tk$">
      <title>Visualisation</title>
      <chart>
        <search base="base">
          <query>| timechart count by *.name</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel depends="$form.event$,$pivot_tk$" rejects="$timechart_tk$,$stats_tk$">
      <title>Visualisation</title>
      <chart>
        <search>
          <query>$splquery$ | stats count by $entity$.name</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel depends="$form.event$,$timechart_tk$,$stats_tk$,$by$" rejects="$pivot_tk$">
      <title>Visualisation</title>
      <chart>
        <search base="base">
          <query>| timechart count by $stats_op$_$entity$.name</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel depends="$form.event$,$pivot_tk$,$stats_tk$,$by$" rejects="$timechart_tk$">
      <title>Visualisation</title>
      <chart>
        <search base="base">
          <query>| stats count by $stats_op$_$entity$.name</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$help_tk$" rejects="$query_tk$">
    <panel>
      <html>
        <p>
          <strong>Enter a natural language statement/pattern like <i>privileged account with a failed authentication</i>
          </strong>
          <br/>
    Start your statement with a relevant subject/object/component for your search (e.g. <i>account</i>). You could precede this entity with one or more adjectives and follow with an event (if you do not enter any the system will give a choice of suitable events related to the main entity). You could also precede your event with one or more adverbs.
        </p>
    </html>
    </panel>
  </row>
  <row depends="$query_tk$,$help_tk$" rejects="$and_tk$">
    <panel>
      <html>
        <p>
          <strong>Click on the statement that is closer to your desired result</strong>
          <br/>
          <strong>*</strong>To execute the query generated by the current selection, click on the query checkbox and then update time period and/or visualisation
        </p>
    </html>
    </panel>
  </row>
  <row depends="noshow">
    <panel>
      <html>
        <!--color:#1A237E !important;
          background-color:#F0F0F0 !important; -->
      <style>
         #text .splunk-textinput {
          min-width: 350px !important;
          width: 350px !important;
          max-width: 350px !important;
          background-color:#030521 !important;
        }
        #text1 .splunk-textinput {
          min-width: 350px !important;
          width: 350px !important;
          max-width: 350px !important;
          background-color:#030521 !important;
        }
        .splunk-textinput {
          min-width: 350px !important;
          width: 350px !important;
          max-width: 350px !important;
          background-color:#030521 !important;
        }
        #radio .splunk-radiogroup {
          min-width: 350px !important;
          width: 350px !important;
          max-width: 350px !important;
          background-color:#030521 !important;
        }
       .splunk-radiogroup {
          min-width: 240px !important;
          width: 240px !important;
          max-width: 240px !important;
          padding-left:150px !important;
        }
        .splunk-radiogroup .select2-container {
          min-width: 250px !important;
          width: 250px !important;
          max-width: 250px !important;
          background-color:#030521 !important;
          padding-left:250px !important;
        } 
      </style>
    </html>
    </panel>
  </row>
</form>